{% extends "core2.html" %}
{% load static %}
{% block content %}

<div class="container-fluid py-4">



  
  <!-- Modal -->
      <div class="modal fade bd-example-modal-lg" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-focus="false">
        <div class="modal-dialog modal-xl" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Agendar Visita</h5>
              
            </div>
            <div class="modal-body">
              <div class="p-4">
              <form>

                <div class="row mt-4">
                  <div class="col-md-6">
                    <div class="my-3">
                      <label class="form-label">Tipo de visita</label>
                        <select type="text" id="choices-modelo" class="form-control">
                             <option value="">Seleccionar tipo</option>  
                         
                             <option value="Aleatoria">Aleatoria</option>
                             <option value="Mantenimiento">Mantenimiento</option>
                             <option value="Pre-empleo">Pre-empleo</option>             
                        </select>
                    </div>
                  </div>


                  
               </div>

                
                <div class="row">
                  <div class="col-md-6">
                    <div class="input-group input-group-static my-3">
                      <label>Fecha Servicio</label>
                      <input type="date" id="picker" class="form-control">
                    </div>
                  </div>


                </div>

               
                
                
                <div class="row">
                   <div class="col-12">
                    <label  class="form-label">Motivo</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="1" placeholder="Describa el motivo de la cita" spellcheck="false" id="motivo" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
                </div>
                <br>

                <div class="row">
                   <div class="col-12">
                    <label  class="form-label">Observaciones</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="2" placeholder="Describa Observaciones de la cita" spellcheck="false" id="observaciones" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
                </div>


                <div class="row mt-4">
                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Nombre</label>
                        <input  type="text" class="form-control" style="text-transform:uppercase;" id="nombre" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>

                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Apellido</label>
                        <input  type="text" class="form-control" style="text-transform:uppercase;" id="apellido" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>
                  
                </div>

                


                <div class="row mt-4">
                  <div class="col-4">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Cedula</label>
                        <input  type="number" class="form-control" style="text-transform:uppercase;" id="identificacion" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>

                  <div class="col-4">
                     <div class="">
                        <select type="text" id="choices-sexo" class="form-control">
                             <option value="">Sexo</option>               
                             <option value="Femenino">Femenino</option>
                             <option value="Masculino">Masculino</option>
                        </select>
                    </div>
                  </div>
                  <div class="col-4">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Telefonos</label>
                        <input type="number" class="form-control" id="telefono" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>
               </div>

               <br>
               
               <div class="row">
                  <div class="col-6">
                    <div class="input-group input-group-static">
                      <label>Fecha Nacimiento</label>
                      <input type="date" id="nacimiento" class="form-control">
                    </div>
                  </div>
                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Ciudad nacimiento</label>
                        <input type="text" class="form-control" id="ciudad_nacimiento" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>
               </div>

               <div class="row mt-4">
                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Nacionalidad</label>
                        <input type="text" class="form-control" id="nacionalidad" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>

                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Departamento</label>
                        <input type="text" class="form-control" id="departamento" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>
                  
               </div>


               <div class="row mt-4">
                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Puesto</label>
                        <input type="text" class="form-control" id="puesto" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>

                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Direccion residencia</label>
                        <input type="text" class="form-control" id="direccion" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>
                  
               </div>

               <div class="row mt-4">
                  <div class="col-6">
                     <div class="input-group input-group-outline">
                        <label for="projectName" class="form-label">Punto referencia</label>
                        <input type="text" class="form-control" id="punto_referencia" style="text-transform:uppercase;" onfocus="focused(this)" onfocusout="defocused(this)">
                     </div>
                  </div>

                  <div class="col-6">
                     <div class="">
                        <select type="text" id="choices-estado" class="form-control">
                             <option value="">Seleccionar estado civil</option>
                             <option value="Casado(a)">Casado(a)</option>               
                             <option value="Soltero(a)">Soltero(a)</option>
                            
                             <option value="Unión libre">Unión libre</option>
                             <option value="Viudo(a)">Viudo(a)</option>
                             
                        </select>
                    </div>
                  </div>
                  
               </div>




              </form>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" onclick="enviar_visita()" class="btn btn-info">Registrar</button>
              <button type="button" onclick="cerrarmodal()" class="btn btn-secondary">Cerrar</button>
              
            </div>
          </div>
        </div>
      </div>



        <!-- Modal -->
      <div class="modal fade bd-example-modal-lg" id="exampleModal2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-focus="false">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Solicitud de servicio</h5>
              
            </div>
            <div class="modal-body">
              <div class="p-4">
              <form>


                <div class="row">
                   <div class="col-12" id="ocultartitulo">
                    <label  class="form-label">Titulo</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="1" placeholder="Describa el titulo ddel servicio" spellcheck="false" id="servicio_titulo" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>

                  <div class="col-12">
                    <div style="display: none;" id="preloader3">
                                                            <div class="sk-folding-cube">
                                                                <div class="sk-cube1 sk-cube"></div>
                                                                <div class="sk-cube2 sk-cube"></div>
                                                                <div class="sk-cube4 sk-cube"></div>
                                                                <div class="sk-cube3 sk-cube"></div>
                                                            </div>
                                                            <div style="text-align: center">
                                                                <h5><font color="#f89420">Espere...</font></h5>
                                                            </div>
                                                        </div>
                  </div>
                  
                  
                </div>

               

                
                

            
              </form>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="ocultarbotoncita" onclick="validar()" class="btn btn-info">Registrar</button>
              <button type="button" onclick="cerrarmodalservicio()" class="btn btn-secondary">Cerrar</button>
              
            </div>
          </div>
        </div>
      </div>



      <!-- Modal -->
      <div class="modal fade bd-example-modal-lg" id="exampleModal3" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-focus="false">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Detalle de visita</h5>
              
            </div>
            <div class="modal-body">
              <div class="p-4">
              <form>


                
               

                
                

            
              </form>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="ocultarbotoncita" onclick="registrar_servicio()" class="btn btn-info">Registrar</button>
              <button type="button" onclick="cerrarmodalservicio()" class="btn btn-secondary">Cerrar</button>
              
            </div>
          </div>
        </div>
      </div>


      <div class="row">
   <div class="col-12 mt-3">
      <div class="card mt-4">
         <div class="card-header p-3 pt-2">
            <div class="icon icon-lg icon-shape bg-gradient-warning shadow text-center border-radius-xl mt-n4 float-start">
               <i class="material-icons opacity-10">splitscreen</i>
            </div>
            <div class="row">
               <div class="col-md-6">
                  <h6 class="mb-0">Solicitudes de servicio</h6>
               </div>
               <div class="col-md-6 d-flex justify-content-end align-items-center">
                  <a onclick="nuevoservicio()" class="btn bg-gradient-warning btn-sm mb-0" >+&nbsp; Solicitar Servicio</a>
               </div>
            </div>
         </div>
         <div class="card-body p-3 pt-4">
            <ul class="list-group list-group-flush" data-toggle="checklist" id="tableservicio">
               
               
               
               
            </ul>
         </div>
      </div>
   </div>
</div>


      <br>
      <br>





	<div class="row">
<div class="col-xl-12">
          <div class="card card-calendar">
            <div class="card-body p-3">
              <div class="calendar" data-bs-toggle="calendar" id="calendar"></div>
            </div>
          </div>
        </div>





</div>

</div>

  <script src="{% static 'assets/js/plugins/fullcalendar.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/choices.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>

  <script type="text/javascript">

     function formatearFecha(fechaStr) {
            // Convierte el string de fecha a un objeto Date
            const [fecha, tiempo] = fechaStr.split(' '); // Separa fecha y tiempo
            const [dia, mes, anio] = fecha.split('-'); // Separa día, mes y año
            const [horas, minutos, meridiano] = tiempo.split(':'); // Separa horas y minutos

            // Ajusta la hora si es PM
            let horasNumerico = parseInt(horas);
            if (meridiano === 'PM' && horasNumerico < 12) {
                horasNumerico += 12;
            } else if (meridiano === 'AM' && horasNumerico === 12) {
                horasNumerico = 0;
            }

            // Crea un nuevo objeto Date
            const fechaObj = new Date(anio, mes - 1, dia, horasNumerico, minutos); // mes - 1 porque los meses empiezan en 0
            fecharaw = fechaObj;

            const anioFormateado = fechaObj.getFullYear();
            const mesFormateado = String(fechaObj.getMonth() + 1).padStart(2, '0');
            const diaFormateado = String(fechaObj.getDate()).padStart(2, '0');
            const horasFormateadas = String(fechaObj.getHours()).padStart(2, '0');
            const minutosFormateados = String(fechaObj.getMinutes()).padStart(2, '0');

            return `${anioFormateado}-${mesFormateado}-${diaFormateado} ${horasFormateadas}:${minutosFormateados}`;
        }




    let fechaSeleccionada = '';
    let fechaFinal = '';
    let fecharaw;

    var fecha_nacimiento;
    var calendariopicker = flatpickr("#picker", {
        allowInput: true,
        onChange: function(selectedDates, dateStr) {
                fechaSeleccionada = dateStr;
                console.log(fechaSeleccionada); // Almacena la fecha seleccionada
                const fechaFinal = formatearFecha(fechaSeleccionada);
                console.log(fechaFinal);
                console.log(fecharaw);
                

        },

        dateFormat: "d-m-Y H:i K",
        enableTime: true,
        locale: {
        firstDayOfWeek: 1,
        weekdays: {
          shorthand: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
          longhand: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],         
        }, 
        months: {
          shorthand: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Оct', 'Nov', 'Dic'],
          longhand: ['Enero', 'Febreo', 'Мarzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        },
        
      },  // locale for this instance only
    });


    if (document.getElementById('choices-modelo')) {
      var element4 = document.getElementById('choices-modelo');
      const example4 = new Choices(element4, {
        searchEnabled: false
      });
    };

    if (document.getElementById('choices-estado')) {
      var element6 = document.getElementById('choices-estado');
      const example6 = new Choices(element6, {
        searchEnabled: false
      });
    };

    var currentid;

    function nuevacita(id){
      currentid = id;

      console.log("boton nuevo paciente presionado");
      $('#exampleModal').modal('show');

    }



    function cerrarmodal(){
      console.log("boton nuevo paciente presionado");
      $('#exampleModal').modal('hide');

    }


    function verdetalle(id){
      
      console.log("ID"+id)
      const baseUrl = '{% url "detalle_visita_id" id=0 %}';
      const url = baseUrl.replace('0', id);
      // Redirige a la URL construida
      window.location.href = url;
    


    }


    function cerrardetalle(){
      
      console.log("boton nuevo paciente presionado");
      $('#exampleModal3').modal('hide');

    }

    


    function nuevoservicio(){
      
      console.log("ID"+currentid)
      console.log("boton nuevo paciente presionado");
      $('#exampleModal2').modal('show');

    }



    function cerrarmodalservicio(){
      console.log("boton nuevo paciente presionado");
      $('#exampleModal2').modal('hide');

    }

    function alertas(titulo,icono,texto){
      Swal.fire({
                    position: "top-end",
                    icon: icono,
                    title: titulo,
                    text: texto,
                    showConfirmButton: false,
                    timer: 4000
                  });
    }

    function alertas_pregunta(titulo,icono,texto,boton1,titulo1,texto1,icono1){
       Swal.fire({
        title: titulo,
        text: texto,
        icon: icono,
        
        confirmButtonColor: "#3085d6",
        
        confirmButtonText: boton1
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: titulo1,
            text: texto1,
            icon: icono1
          });
        }
      });
    }


   



    function eliminar_servicio(id){


        Swal.fire({
        title: "Servicio",
        text: "Esta seguro de eliminar este servicio?",
        icon: "info",
        showCancelButton: false,
        confirmButtonColor: "#FFA726",
        cancelButtonColor: "#d33",
        confirmButtonText: "Eliminar"
      }).then((result) => {
        if (result.isConfirmed) {


      var idservicio = id;

      

      var datos = new FormData();

      datos.append('idservicio', idservicio);
      
      
      $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'eliminar_servicio'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                //Maneja la respuesta JSON aquí
                console.log(data);
                alertas("Servicio","warning","Servicio eliminado");
                consulta_servicio();
                
            },
            error: function(error) {
                //Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
                //alertas("Visita","success","Visita registrada correctamente");
            }
        });
          
        }
      });


      
     }


     function eliminar_cita(id){


        Swal.fire({
        title: "Visita",
        text: "Esta seguro de eliminar esta Visita?",
        icon: "info",
        showCancelButton: false,
        confirmButtonColor: "#FFA726",
        cancelButtonColor: "#d33",
        confirmButtonText: "Eliminar"
      }).then((result) => {
        if (result.isConfirmed) {


      var idcita = id;

      

      var datos = new FormData();

      datos.append('idcita', idcita);
      
      
      $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'eliminar_cita'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                //Maneja la respuesta JSON aquí
                console.log(data);
                alertas("Visita","warning","Visita Eliminada");
                consulta_servicio();
                
            },
            error: function(error) {
                //Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
                //alertas("Visita","success","Visita registrada correctamente");
            }
        });
          
        }
      });


      
     }


     function enviar_visita(){

      var fecha_cita = calendariopicker.formatDate(fecharaw, "Y-m-d h:i");


      var motivo =  document.getElementById("motivo").value;
      var observaciones =  document.getElementById("observaciones").value;
      var tipo_visita =  document.getElementById("choices-modelo").value;
      var nombre =  document.getElementById("nombre").value;
      var apellido =  document.getElementById("apellido").value;
      var identificacion =  document.getElementById("identificacion").value;
      var sexo =  document.getElementById("choices-sexo").value;
      var telefono =  document.getElementById("telefono").value;
      var nacimiento =  document.getElementById("nacimiento").value;
      var ciudad_nacimiento =  document.getElementById("ciudad_nacimiento").value;
      var nacionalidad =  document.getElementById("nacionalidad").value;
      var departamento =  document.getElementById("departamento").value;
      var puesto =  document.getElementById("puesto").value;
      var direccion =  document.getElementById("direccion").value;
      var punto_referencia =  document.getElementById("punto_referencia").value;
      var estado_civil =  document.getElementById("choices-estado").value;
      var idservicio = currentid;

      var datos = new FormData();

      datos.append('motivo', motivo);
      datos.append('observaciones', observaciones);

      datos.append('tipo_visita', tipo_visita);
      datos.append('nombre', nombre);
      datos.append('apellido', apellido);
      datos.append('identificacion', identificacion);
      datos.append('sexo', sexo);
      datos.append('telefono', telefono);
      datos.append('nacimiento', nacimiento);
      datos.append('ciudad_nacimiento', ciudad_nacimiento);
      datos.append('nacionalidad', nacionalidad);
      datos.append('departamento', departamento);
      datos.append('puesto', puesto);
      datos.append('direccion', direccion);
      datos.append('punto_referencia', punto_referencia);
      datos.append('estado_civil', estado_civil);
      datos.append('idservicio', idservicio);
      datos.append('fecha_cita', fecha_cita);

      console.log("fecha_cita");

      console.log(fecha_cita);

      $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'registrar_cita_new'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                //Maneja la respuesta JSON aquí
                console.log(data);
                alertas("Cita","success","Cita registrada correctamente");
                cerrarmodal();
                consulta_servicio();
                inicar_calendario();


                document.getElementById("motivo").value = "";
                document.getElementById("observaciones").value = "";
                document.getElementById("choices-modelo").value = "";
                document.getElementById("nombre").value = "";
                document.getElementById("apellido").value = "";
                document.getElementById("identificacion").value = "";
                
                document.getElementById("telefono").value = "";
                document.getElementById("nacimiento").value = "";
                document.getElementById("ciudad_nacimiento").value = "";
                document.getElementById("nacionalidad").value = "";
                document.getElementById("departamento").value = "";
                document.getElementById("puesto").value = "";
                document.getElementById("direccion").value = "";
                document.getElementById("punto_referencia").value = "";
                
               
            },
            error: function(error) {
                //Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
                //alertas("Visita","success","Visita registrada correctamente");
            }
        });

      
     }


    function registrar_cita(){

      console.log("fecha aca arriba");

      if (calendariopicker.selectedDates && calendariopicker.selectedDates.length > 0) {
          var fechaSeleccionada = calendariopicker.selectedDates[0];
          console.log("Fecha seleccionada:", calendariopicker.formatDate(new Date(), "Y-m-d h:i K"));
        } else {
          console.log("No se ha seleccionado ninguna fecha.");
        }

      var fecha_cita = calendariopicker.formatDate(new Date(), "Y-m-d h:i K");
      var direccion = document.getElementById("direccion").value;

      var motivo =  document.getElementById("motivo").value;
      var observaciones =  document.getElementById("observaciones").value;

      console.log(motivo);
      console.log(observaciones);
      console.log(direccion);


      var datos = new FormData();


      datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      datos.append('fecha_cita', fecha_cita);
      datos.append('motivo', motivo);
      datos.append('observaciones', observaciones);
      datos.append('direccion', direccion);


      $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'registar_cita'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);
                cerrarmodal();
                alertas("Cita","success",data.mensaje);
                inicar_calendario();


                

               
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });

      
    }

    


    function consulta_servicio(){
      var servicio_titulo = document.getElementById("servicio_titulo").value;

      var datos = new FormData();


      datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      datos.append('servicio_titulo', servicio_titulo);


      $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'consulta_servicio'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);
                
                //inicar_calendario();


                $('#tableservicio').empty();

                console.log("tabla vacia")

                
                for (var i = 0; i < data.servicio.length; i++) {

                var myString = `<li class="list-group-item border-0 flex-column align-items-start ps-0 py-0 mb-3">
                  <div class="checklist-item checklist-item-warning ps-2 ms-3">
                     <div class="d-flex align-items-center">
                        
                        <h6 class="mb-0 text-dark text-sm">`+data.servicio[i].titulo.toUpperCase()+`</h6>
                        <div class="dropstart  float-lg-end ms-auto">
                           
                           <td class="text-sm">
                             <a onclick="nuevacita(`+data.servicio[i].id+`)" data-bs-toggle="tooltip" data-bs-original-title="Preview product">
                               <i class="material-icons text-secondary position-relative text-lg">person_add</i>
                             </a>
                             <a onclick="nuevacita(`+data.servicio[i].id+`)" class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit product">
                               <i class="material-icons text-secondary position-relative text-lg">visibility</i>
                             </a>
                             <a onclick="eliminar_servicio(`+data.servicio[i].id+`)" data-bs-toggle="tooltip" data-bs-original-title="Delete product">
                               <i class="material-icons text-secondary position-relative text-lg">delete</i>
                             </a>
                           </td>
                           
                        </div>
                     </div>
                     <div class="d-flex align-items-center ms-4 mt-3 ps-1">
                        <div>
                           <p class="mb-0 text-secondary">Fecha</p>
                           <span class="text-xs">`+data.servicio[i].fecha+`</span>
                        </div>
                        <div class="ms-auto">
                           <p class="mb-0 text-secondary">Cantidad de visitas</p>
                           <span class="text-xs">`+data.servicio[i].visitas_asignadas.length+`</span>
                        </div>
                        <div class="mx-auto">
                           <p class="mb-0 text-secondary">Usuario soliticante</p>
                           <span class="text-xs">`+data.servicio[i].solcitante+`</span>
                        </div>
                     </div>


                      <div class="card">
                      <div class="table-responsive">
                        <table class="table align-items-center mb-0">
                          <thead>
                            <tr>
                              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nombre</th>
                              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Fecha</th>
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">acciones</th>
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Employed</th>
                              <th class="text-secondary opacity-7"></th>
                            </tr>
                          </thead>
                          <tbody id="tablavisitas`+data.servicio[i].id+`">

                            
                          </tbody>
                        </table>
                      </div>
                    </div>

                    

                  </div>
                  <hr class="horizontal dark mt-4 mb-0">
               </li>`


               $('#tableservicio').append(myString);
               
            }

            for (var i = 0; i < data.servicio.length; i++) {

               for (var j = 0; j < data.servicio[i].visitas_asignadas.length; j++){

                 var visitas = `<tr>
                            <td>
                             <div class="icon icon-shape bg-gradient-warning shadow text-center">
                                    <i class="material-icons opacity-10 pt-1">person</i>
                                  </div>
                            </td>
                              <td>
                                <div class="d-flex px-2 py-1">
                                 
                                  <div class="d-flex flex-column justify-content-center">
                                    <h6 class="mb-0 text-xs">`+data.servicio[i].visitas_asignadas[j].nombres.toUpperCase()+ " " +data.servicio[i].visitas_asignadas[j].apellidos.toUpperCase()+`</h6>
                                    <p class="text-xs text-secondary mb-0">`+data.servicio[i].visitas_asignadas[j].cedula+`</p>
                                  </div>
                                </div>
                              </td>
                              <td>
                                <p class="text-xs font-weight-bold mb-0">`+data.servicio[i].visitas_asignadas[j].fecha+`</p>
                                <p class="text-xs text-secondary mb-0"></p>
                              </td>
                              <td class="align-middle text-center text-sm">
                                <span class="badge badge-sm badge-warning">`+data.servicio[i].visitas_asignadas[j].estatus+`</span>
                              </td>
                              <td class="align-middle text-center">
                                <span class="text-secondary text-xs font-weight-normal"></span>
                              </td>
                              <td class="text-sm">
                             
                             <a onclick="verdetalle(`+data.servicio[i].visitas_asignadas[j].id+`)" class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit product">
                               <i class="material-icons text-secondary position-relative text-lg">visibility</i>
                             </a>
                             <a onclick="eliminar_cita(`+data.servicio[i].visitas_asignadas[j].id+`)" data-bs-toggle="tooltip" data-bs-original-title="Delete product">
                               <i class="material-icons text-secondary position-relative text-lg">delete</i>
                             </a>
                           </td>
                            </tr>`

                    

                 


                    $('#tablavisitas'+data.servicio[i].id).append(visitas);
               }

             }
               
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });

      
    }

    function validar(){

        var servicio_titulo = document.getElementById("servicio_titulo").value;

        if (servicio_titulo.length === 0) {
            alertas("Servicio","info","El campo servicio no puede estar vacio");

        }
        else {
            registrar_servicio();
        }

    }


    function registrar_servicio(){

    
     document.getElementById("ocultartitulo").style.display = "none";
     document.getElementById("ocultarbotoncita").style.display = "none";
     
     document.getElementById("preloader3").style.display = "inline";

      

      var servicio_titulo = document.getElementById("servicio_titulo").value;

      var datos = new FormData();


      datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      
      datos.append('servicio_titulo', servicio_titulo);


      $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'crear_servicio'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);
                cerrarmodalservicio();
                alertas("Servicio","success",data.mensaje);
                //inicar_calendario();


                $('#tableservicio').empty();

                console.log("tabla vacia")

                for (var i = 0; i < data.servicio.length; i++) {

                var myString = `<li class="list-group-item border-0 flex-column align-items-start ps-0 py-0 mb-3">
                  <div class="checklist-item checklist-item-warning ps-2 ms-3">
                     <div class="d-flex align-items-center">
                        
                        <h6 class="mb-0 text-dark text-sm">`+data.servicio[i].titulo.toUpperCase()+`</h6>
                        <div class="dropstart  float-lg-end ms-auto">
                           
                           <td class="text-sm">
                             <a onclick="nuevacita(`+data.servicio[i].id+`)" data-bs-toggle="tooltip" data-bs-original-title="Preview product">
                               <i class="material-icons text-secondary position-relative text-lg">person_add</i>
                             </a>
                             <a onclick="nuevacita(`+data.servicio[i].id+`)" class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit product">
                               <i class="material-icons text-secondary position-relative text-lg">visibility</i>
                             </a>
                             <a onclick="eliminar_servicio(`+data.servicio[i].id+`)" data-bs-toggle="tooltip" data-bs-original-title="Delete product">
                               <i class="material-icons text-secondary position-relative text-lg">delete</i>
                             </a>
                           </td>
                           
                        </div>
                     </div>
                     <div class="d-flex align-items-center ms-4 mt-3 ps-1">
                        <div>
                           <p class="mb-0 text-secondary">Fecha</p>
                           <span class="text-xs">`+data.servicio[i].fecha+`</span>
                        </div>
                        <div class="ms-auto">
                           <p class="mb-0 text-secondary">Cantidad de visitas</p>
                           <span class="text-xs">`+data.servicio[i].visitas_asignadas.length+`</span>
                        </div>
                        <div class="mx-auto">
                           <p class="mb-0 text-secondary">Usuario soliticante</p>
                           <span class="text-xs">`+data.servicio[i].solcitante+`</span>
                        </div>
                     </div>


                      <div class="card">
                      <div class="table-responsive">
                        <table class="table align-items-center mb-0">
                          <thead>
                            <tr>
                              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nombre</th>
                              <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Fecha</th>
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">acciones</th>
                              <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Employed</th>
                              <th class="text-secondary opacity-7"></th>
                            </tr>
                          </thead>
                          <tbody id="tablavisitas`+data.servicio[i].id+`">

                            
                          </tbody>
                        </table>
                      </div>
                    </div>

                    

                  </div>
                  <hr class="horizontal dark mt-4 mb-0">
               </li>`


               
               $('#tableservicio').append(myString);

               }


               for (var i = 0; i < data.servicio.length; i++) {

               for (var j = 0; j < data.servicio[i].visitas_asignadas.length; j++){

                 var visitas = `<tr>
                            <td>
                             <div class="icon icon-shape bg-gradient-warning shadow text-center">
                                    <i class="material-icons opacity-10 pt-1">person</i>
                                  </div>
                            </td>
                              <td>
                                <div class="d-flex px-2 py-1">
                                 
                                  <div class="d-flex flex-column justify-content-center">
                                    <h6 class="mb-0 text-xs">`+data.servicio[i].visitas_asignadas[j].nombres.toUpperCase()+ " " +data.servicio[i].visitas_asignadas[j].apellidos.toUpperCase()+`</h6>
                                    <p class="text-xs text-secondary mb-0">`+data.servicio[i].visitas_asignadas[j].cedula+`</p>
                                  </div>
                                </div>
                              </td>
                              <td>
                                <p class="text-xs font-weight-bold mb-0">`+data.servicio[i].visitas_asignadas[j].fecha+`</p>
                                <p class="text-xs text-secondary mb-0"></p>
                              </td>
                              <td class="align-middle text-center text-sm">
                                <span class="badge badge-sm badge-warning">`+data.servicio[i].visitas_asignadas[j].estatus+`</span>
                              </td>
                              <td class="align-middle text-center">
                                <span class="text-secondary text-xs font-weight-normal"></span>
                              </td>
                              <td class="text-sm">
                             
                             <a onclick="verdetalle(`+data.servicio[i].visitas_asignadas[j].id+`)" class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit product">
                               <i class="material-icons text-secondary position-relative text-lg">visibility</i>
                             </a>
                             <a onclick="eliminar_cita(`+data.servicio[i].visitas_asignadas[j].id+`)" data-bs-toggle="tooltip" data-bs-original-title="Delete product">
                               <i class="material-icons text-secondary position-relative text-lg">delete</i>
                             </a>
                           </td>
                            </tr>
                      
                      
                      
                     `

                    

                 


                    $('#tablavisitas'+data.servicio[i].id).append(visitas);
               }

             }

             document.getElementById("preloader3").style.display = "none";
             document.getElementById("ocultartitulo").style.display = "inline";
             document.getElementById("ocultarbotoncita").style.display = "inline";

             document.getElementById("servicio_titulo").value = "";
               
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });

      
    }

  </script>

  <script>

    
    
  </script>

 <script>


function inicar_calendario(){
    var usuario_solicitud = {{request.user.id}};
 

    var datos = new FormData();


    datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    datos.append('usuario_solicitud', usuario_solicitud);

    var events = []

    $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'administrar_citas'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);
                console.log("datos consultados para el calendario");


                $('#table').empty();

                for (var i = 0; i < data.Citas.length; i++) {

                    events.push({title: data.Citas[i].usuario_solicitud.toUpperCase(),start: data.Citas[i].fecha_agenda_normal,end: data.Citas[i].fecha_agenda_normal,className: 'bg-gradient-warning'});

                    }

                    //console.log();
                    calendario(events);
                    //console.log(data.Pacientes);


                    if (document.getElementById('choices-sexo')) {
                      var element = document.getElementById('choices-sexo');
                      const example2 = new Choices(element, {
                        searchEnabled: true
                      });
                    };


               
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });
}

$( document ).ready(function() {
 	inicar_calendario();
    consulta_servicio();
 });

  </script>

  <script type="text/javascript">


  	function calendario(eventos){

  			var today = new Date().getFullYear()+'-'+("0"+(new Date().getMonth()+1)).slice(-2)+'-'+("0"+new Date().getDate()).slice(-2)
  		


  		  var calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
  		    buttonText:{ today:'Hoy' },
  		    locale: 'es',
  		    contentHeight: 'auto',
  		    initialView: "dayGridMonth",
  		    headerToolbar: {
  		      start: 'title', // will normally be on the left. if RTL, will be on the right
  		      center: '',
  		      end: 'today prev,next' // will normally be on the right. if RTL, will be on the left
  		    },
  		    selectable: true,
  		    editable: true,
  		    initialDate: today,
  		    events: eventos,
  		    views: {
  		      month: {
  		        titleFormat: {
  		          month: "long",
  		          year: "numeric"
  		        }
  		      },
  		      agendaWeek: {
  		        titleFormat: {
  		          month: "long",
  		          year: "numeric",
  		          day: "numeric"
  		        }
  		      },
  		      agendaDay: {
  		        titleFormat: {
  		          month: "short",
  		          year: "numeric",
  		          day: "numeric"
  		        }
  		      }
  		    },
  		  });

  		  //calendar.setOption('locale', 'es');

  		  calendar.render();


  	}
  	
  </script>

{% endblock %}