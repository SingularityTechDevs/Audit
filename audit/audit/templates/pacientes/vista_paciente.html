{% extends "core2.html" %}
{% load static %}
{% block content %} 
{% if paciente %}




<div class="container-fluid my-3 py-3">

<!-- Modal -->
      <div class="modal fade bd-example-modal-lg" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-focus="false">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Nueva Consulta</h5>
              
            </div>
            <div class="modal-body">
              <div class="p-4">
              <form>

                <div class="row mt-4">
                  <div class="col-12">
                    <label for="projectName" class="form-label">Motivo consulta</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="2" placeholder="Ingrese el motivo de la consulta" spellcheck="false" id="motivo" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
               </div>

               <div class="row mt-4">
                  <div class="col-12">
                    <label for="projectName" class="form-label">Sintomas</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="2" placeholder="Ingrese los sintomas que presenta el paciente" spellcheck="false" id="sintomas" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
               </div>

               <div class="row mt-4">
                  <div class="col-12">
                    <label for="projectName" class="form-label">Diagnostico</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="2" placeholder="Ingrese el diagnostico" spellcheck="false" id="diagnostico" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
               </div>

               <div class="row mt-4">
                  <div class="col-12">
                    <label for="projectName" class="form-label">Tratamiento</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="2" placeholder="Ingrese el tratamiento" spellcheck="false" id="tratamiento" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
               </div>
                
                
              </form>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" onclick="registrar_consulta()" class="btn btn-info">Registrar</button>
              <button type="button" onclick="cerrarmodalpaciente()" class="btn btn-secondary">Cerrar</button>
              
            </div>
          </div>
        </div>
      </div>



      <div class="row mb-5">
        <div class="col-lg-3">
          <div class="card position-sticky top-1">
            <ul class="nav flex-column bg-white border-radius-lg p-3">
              <li class="nav-item">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#profile">
                  <i class="material-icons text-lg me-2">person</i>
                  <span class="text-sm">Perfil Paciente</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#basic-info">
                  <i class="material-icons text-lg me-2">receipt_long</i>
                  <span class="text-sm">Informacion Basica</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#password">
                  <i class="material-icons text-lg me-2">lock</i>
                  <span class="text-sm">Consultas</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#2fa">
                  <i class="material-icons text-lg me-2">security</i>
                  <span class="text-sm">Recetas</span>
                </a>
              </li>
              
             
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#sessions">
                  <i class="material-icons text-lg me-2">settings_applications</i>
                  <span class="text-sm">Diagnosticos</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#delete">
                  <i class="material-icons text-lg me-2">delete</i>
                  <span class="text-sm">Desvinculacion & Alertas</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="col-lg-9 mt-lg-0 mt-4">
          <!-- Card Profile -->
          <div class="card card-body" id="profile">
            <div class="row justify-content-center align-items-center">
              <div class="col-sm-auto col-4">
                <div class="avatar avatar-xl position-relative">
                  <img src="{{paciente.foto.url}}" alt="bruce" class="w-100 rounded-circle shadow-sm">
                </div>
              </div>
              <div class="col-sm-auto col-8 my-auto">
                <div class="h-100">
                  <h5 class="mb-1 font-weight-bolder">
                    {{paciente.nombre_completo}}
                  </h5>
                  <p class="mb-0 font-weight-normal text-sm">
                    {{paciente.identificacion}}
                  </p>
                </div>
              </div>
              <div class="col-sm-auto ms-sm-auto mt-sm-0 mt-3 d-flex">
                
              </div>
            </div>
          </div>
          <!-- Card Basic Info -->
          <div class="card mt-4" id="basic-info">
            <div class="card-header">
              <h5>Informacion Basica</h5>
            </div>
            <div class="card-body pt-0">
              <div class="row">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Nombre</label>
                    <input disabled type="text" class="form-control" placeholder="" value="{{paciente.nombre_completo}}">
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Identificacion</label>
                    <input disabled type="text" class="form-control" placeholder="" value="{{paciente.identificacion}}">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Tipo Identificacion</label>
                    <input disabled type="text" class="form-control" placeholder="" value="{{paciente.tipo_identificacion}}">
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Edad</label>
                    <input disabled type="text" class="form-control" placeholder="" value="{{paciente.edad_actual}}">
                  </div>
                </div>
                
              </div>
              <div class="row mt-4">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Fecha Nacimiento</label>
                    <input disabled type="text" class="form-control" placeholder="" value='{{paciente.edad|date:"d-m-Y"}}'>
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Sexo </label>
                    <input disabled type="text" class="form-control" placeholder="" value='{{paciente.get_sexo_display}}'>
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Celular </label>
                    <input disabled type="text" class="form-control" placeholder="" value='{{paciente.telefono_mask}}'>
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Correo Electronico </label>
                    <input disabled type="text" class="form-control" placeholder="" value='{{paciente.correo_electronico}}'>
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-12">
                  <div class="input-group input-group-static">
                    <label>Direccion </label>
                    <input disabled type="text" class="form-control" placeholder="" value='{{paciente.direccion}}'>
                  </div>
                </div>
                
              </div>
            </div>
          </div>
          <!-- Card Change Password -->
          <div class="card mt-4" id="password">
            <div class="card-header d-flex">
              <h5 class="mb-0">Consultas</h5>
              <a onclick="nueva_consulta()" class="btn bg-gradient-info btn-sm ms-auto mb-auto" >+&nbsp; Nueva Consulta</a>
              
            </div>
            <div class="card-body" id="table-consultas">
              
              
            </div>
          </div>
          <!-- Card Change Password -->
          <div class="card mt-4" id="2fa">
            <div class="card-header d-flex">
              <h5 class="mb-0">Ultimas Recetas</h5>
              <a onclick="nuevopaciente()" class="btn bg-gradient-info btn-sm ms-auto mb-auto" >+&nbsp; Nueva Indicacion</a>
              
            </div>
            <div class="card-body">
              
            </div>
          </div>
          
          
          <!-- Card Sessions -->
          <div class="card mt-4" id="sessions">
            <div class="card-header pb-3">
              <h5>Diagnosticos</h5>
              <p class="text-sm">This is a list of devices that have logged into your account. Remove those that you do not recognize.</p>
            </div>
            <div class="card-body pt-0">
              
              
              
              
            </div>
          </div>
          <!-- Card Delete Account -->
          <div class="card mt-4" id="delete">
            <div class="card-body">
              <div class="d-flex align-items-center mb-sm-0 mb-4">
                <div class="w-50">
                  <h5>Desvincular Paciente</h5>
                  <p class="text-sm mb-0">Una vez desvincule el paciente ya no tendra acceso a su informacion a menos que el mismo le conseda acceso nuevamente.</p>
                </div>
                <div class="w-50 text-end">
                  <button class="btn btn-outline-secondary mb-3 mb-md-0 ms-auto" type="button" name="button">Desvincular</button>
                  <button class="btn bg-gradient-danger mb-0 ms-2" type="button" name="button">Reportar alerta</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <footer class="footer py-4  ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                © <script>
                  document.write(new Date().getFullYear())
                </script>,
                made with <i class="fa fa-heart"></i> by
                <a href="https://www.creative-tim.com" class="font-weight-bold" target="_blank">Creative Tim</a>
                for a better web.
              </div>
            </div>
            <div class="col-lg-6">
              <ul class="nav nav-footer justify-content-center justify-content-lg-end">
                <li class="nav-item">
                  <a href="https://www.creative-tim.com" class="nav-link text-muted" target="_blank">Creative Tim</a>
                </li>
                <li class="nav-item">
                  <a href="https://www.creative-tim.com/presentation" class="nav-link text-muted" target="_blank">About Us</a>
                </li>
                <li class="nav-item">
                  <a href="https://www.creative-tim.com/blog" class="nav-link text-muted" target="_blank">Blog</a>
                </li>
                <li class="nav-item">
                  <a href="https://www.creative-tim.com/license" class="nav-link pe-0 text-muted" target="_blank">License</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </footer>
    </div>

<script type="text/javascript">


  $(document).ready(function(){
       consultar_consultas();
    
     });

  function alertas(titulo,icono,texto){
      Swal.fire({
                    position: "top-end",
                    icon: icono,
                    title: titulo,
                    text: texto,
                    showConfirmButton: false,
                    timer: 2000
                  });
    }

  function consultar_consultas(){

    var medico = {{request.user.id}}
    var paciente = {{paciente.id}}

    var datos = new FormData();


    datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    datos.append('medico', medico);
    datos.append('paciente', paciente);

    $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'consultar_consulta'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);
                

                //alertas("Consulta agregada","success",data.mensaje)

                $('#table').empty();

                for (var i = 0; i < data.consultas.length; i++) {

                    var myString = `<div class="d-flex align-items-center">
                       <div class="text-center w-5">
                          <i class="fas fa-user-md text-lg opacity-6" aria-hidden="true"></i>
                       </div>
                       <div class="my-auto ms-3">
                          <div class="h-100">
                             <p class="text-sm mb-1">
                                MEDICO: `+data.consultas[i].medico.toUpperCase()+`
                             </p>
                             <p class="mb-0 text-xs">
                                `+data.consultas[i].diagnostico.toUpperCase()+`
                             </p>
                          </div>
                       </div>
                       <span class="badge badge-success badge-sm my-auto ms-auto me-3">`+data.consultas[i].fecha+`</span>
                       <p class="text-secondary text-sm my-auto me-3">EU</p>
                       <a href="javascript:;" class="text-primary text-sm icon-move-right my-auto">VER MAS
                       <i class="fas fa-arrow-right text-xs ms-1" aria-hidden="true"></i>
                       </a>
                    </div>
                    <hr class="horizontal dark">`


                    $('#table-consultas').append(myString);

                    }

            
                // Puedes hacer más cosas con los datos, como mostrarlos en la página
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });
  }

  function registrar_consulta(){

        //$("#products-list > tbody").html("");
        
        
        var medico = {{request.user.id}}
        var paciente = {{paciente.id}}

        var motivo =  document.getElementById("motivo").value;
        var sintomas =  document.getElementById("sintomas").value;
        var diagnostico =  document.getElementById("diagnostico").value;
        var tratamiento =  document.getElementById("tratamiento").value;


        if (motivo == "") {
          alertas("CAMPO MOTIVO","warning","EL CAMPO MOTIVO NO PUEDE ESTAR VACIO")
        }
        else if (sintomas == "") {
          alertas("CAMPO SINTOMAS","warning","EL CAMPO SINTOMAS NO PUEDE ESTAR VACIO")
        }
        else if (diagnostico == "") {
          alertas("CAMPO DIAGNOSTICO","warning","EL CAMPO DIAGNOSTICO NO PUEDE ESTAR VACIO")
        }
        else if (tratamiento == "") {
          alertas("CAMPO TRATAMIENTO","warning","EL CAMPO TRATAMIENTO NO PUEDE ESTAR VACIO")
        }
        else{

        var datos = new FormData();


        datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        datos.append('medico', medico);
        datos.append('paciente', paciente);
        datos.append('motivo', motivo);
        datos.append('sintomas', sintomas);
        datos.append('diagnostico', diagnostico);
        datos.append('tratamiento', tratamiento);
        // Datos que deseas enviar en el cuerpo del POST
        

        // Realiza la solicitud AJAX con método POST
        $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'crear_consulta'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);
                

                alertas("Consulta agregada","success",data.mensaje)

              

                $('#table').empty();

                
                


                for (var i = 0; i < data.consultas.length; i++) {

                    var myString = `<div class="d-flex align-items-center">
                       <div class="text-center w-5">
                          <i class="fas fa-user-md text-lg opacity-6" aria-hidden="true"></i>
                       </div>
                       <div class="my-auto ms-3">
                          <div class="h-100">
                             <p class="text-sm mb-1">
                                MEDICO: `+data.consultas[i].medico.toUpperCase()+`
                             </p>
                             <p class="mb-0 text-xs">
                                `+data.consultas[i].diagnostico.toUpperCase()+`
                             </p>
                          </div>
                       </div>
                       <span class="badge badge-success badge-sm my-auto ms-auto me-3">`+data.consultas[i].fecha+`</span>
                       <p class="text-secondary text-sm my-auto me-3">EU</p>
                       <a href="javascript:;" class="text-primary text-sm icon-move-right my-auto">VER MAS
                       <i class="fas fa-arrow-right text-xs ms-1" aria-hidden="true"></i>
                       </a>
                    </div>`


                    $('#table-consultas').append(myString);

                    }

                    cerrarmodalpaciente();

            
                // Puedes hacer más cosas con los datos, como mostrarlos en la página
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });

        }



  }

  function nueva_consulta(){
      console.log("boton nuevo paciente presionado");
      $('#exampleModal').modal('show');
    }

    function cerrarmodalpaciente(){
      $('#exampleModal').modal('hide');
    }
</script>
{% endif %}
{% endblock %}