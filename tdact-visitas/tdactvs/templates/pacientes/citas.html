{% extends "core2.html" %}
{% load static %}
{% block content %} 

<div class="container-fluid py-4">
  
  <!-- Modal -->
      <div class="modal fade bd-example-modal-lg" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-focus="false">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Agendar Cita</h5>
              
            </div>
            <div class="modal-body">
              <div class="p-4">
              <form>

                <div class="row">
                  <div class="col-md-12">
                    <div class="my-3">
                      
                        <select type="text" id="choices-identificacion" class="form-control">
                           <option value="" selected="true">Paciente</option> 

                             
                        </select>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="input-group input-group-outline my-3">
                      <label class="form-label">Fecha Cita</label>
                      <input type="date" id="picker" class="form-control">
                    </div>
                  </div>


                </div>
                
                
                <div class="row">
                   <div class="col-12">
                    <label for="projectName" class="form-label">Motivo</label>
                     <div class="input-group input-group-static">
                        
                        <textarea class="form-control" rows="2" placeholder="Describa el motivo de la cita" spellcheck="false" id="uso" style="text-transform:uppercase;"></textarea>
                     </div>
                  </div>
                  
                </div>
              </form>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" onclick="registrar_paciente()" class="btn btn-info">Registrar</button>
              <button type="button" onclick="cerrarmodalpaciente()" class="btn btn-secondary">Cerrar</button>
              
            </div>
          </div>
        </div>
      </div>




	<div class="row">
<div class="col-xl-9">
          <div class="card card-calendar">
            <div class="card-body p-3">
              <div class="calendar" data-bs-toggle="calendar" id="calendar"></div>
            </div>
          </div>
        </div>

<div class="col-xl-3">

   <div class="row">
      <div class="col-xl-12 col-md-6 mt-xl-0 mt-4">
         <div class="card">
            <a onclick="nuevacita()" class="btn bg-gradient-info btn-sm mb-0" >+&nbsp; Agendar Cita</a>
            <div class="card-header p-3 pb-0">
               <h6 class="mb-0">Proximas Citas</h6>
            </div>
            <div class="card-body border-radius-lg p-3" id="table">
               
               
               
               
               
            </div>
         </div>
      </div>
      
   </div>
</div>



</div>

</div>

  <script src="{% static 'assets/js/plugins/fullcalendar.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/choices.min.js' %}"></script>
  <script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>

  <script type="text/javascript">
    
    var fecha_nacimiento;
    var calendario = flatpickr("#picker", {
        allowInput: true,
        dateFormat: "d-m-Y H:i K",
        enableTime: true,
        locale: {
        firstDayOfWeek: 1,
        weekdays: {
          shorthand: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
          longhand: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],         
        }, 
        months: {
          shorthand: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Оct', 'Nov', 'Dic'],
          longhand: ['Enero', 'Febreo', 'Мarzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
        },
        onChange: function(selectedDates, dateStr, instance) {
            fecha_nacimiento = dateStr;
            console.log(fecha_nacimiento);
        }
      },  // locale for this instance only
    });
  </script>

  <script>

    
    
  </script>

 <script>

$( document ).ready(function() {
 	var medico = {{request.user.id}};
 

    var datos = new FormData();


    datos.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    datos.append('medico', medico);

    var events = []

    $.ajax({
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            url: '{% url 'administrar_citas'  %}',  // La URL de tu vista Django
            type: 'POST',
            contentType: 'application/json',  // Indica que estás enviando JSON
            data: datos,
            processData: false,
            contentType: false,  // Convierte los datos a JSON si es necesario
            dataType: 'json',
            success: function(data) {
                // Maneja la respuesta JSON aquí
                console.log(data);


                $('#table').empty();

                for (var i = 0; i < data.Citas.length; i++) {

                   
                    var myString = `<div class="d-flex mt-4">
                       <div class="icon icon-shape bg-gradient-dark shadow text-center">
                          <i class="material-icons opacity-10 pt-1">auto_stories</i>
                       </div>
                       <div class="ms-3">
                          <div class="numbers">
                             <h6 class="mb-1 text-dark text-sm">`+data.Citas[i].paciente.toUpperCase()+`</h6>
                             <span class="text-sm">`+data.Citas[i].fecha_agenda_normal+`</span>
                          </div>
                       </div>
                    </div>`


                    $('#table').append(myString);

                    events.push({title: data.Citas[i].paciente.toUpperCase(),start: data.Citas[i].fecha_agenda_normal,end: data.Citas[i].fecha_agenda_normal,className: 'bg-gradient-danger'});

                    }

                    //console.log();
                    calendario(events);
                    console.log(data.Pacientes);


                    if (document.getElementById('choices-identificacion')) {
                      var element = document.getElementById('choices-identificacion');
                      var example = new Choices(element, {
                        searchEnabled: true,
                        choices:data.Pacientes

                      });

                      
                    };

                    if (document.getElementById('choices-sexo')) {
                      var element = document.getElementById('choices-sexo');
                      const example2 = new Choices(element, {
                        searchEnabled: true
                      });
                    };


               
            },
            error: function(error) {
                // Maneja los errores aquí
                console.error('Error en la solicitud AJAX:', error);
            }
        });
 	});

 	
    
  </script>

  <script type="text/javascript">


   function nuevacita(){
      console.log("boton nuevo paciente presionado");
      $('#exampleModal').modal('show');
    }

  	function calendario(eventos){

  			var today = new Date().getFullYear()+'-'+("0"+(new Date().getMonth()+1)).slice(-2)+'-'+("0"+new Date().getDate()).slice(-2)
  		


  		  var calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
  		    buttonText:{ today:'Hoy' },
  		    locale: 'es',
  		    contentHeight: 'auto',
  		    initialView: "dayGridMonth",
  		    headerToolbar: {
  		      start: 'title', // will normally be on the left. if RTL, will be on the right
  		      center: '',
  		      end: 'today prev,next' // will normally be on the right. if RTL, will be on the left
  		    },
  		    selectable: true,
  		    editable: true,
  		    initialDate: today,
  		    events: eventos,
  		    views: {
  		      month: {
  		        titleFormat: {
  		          month: "long",
  		          year: "numeric"
  		        }
  		      },
  		      agendaWeek: {
  		        titleFormat: {
  		          month: "long",
  		          year: "numeric",
  		          day: "numeric"
  		        }
  		      },
  		      agendaDay: {
  		        titleFormat: {
  		          month: "short",
  		          year: "numeric",
  		          day: "numeric"
  		        }
  		      }
  		    },
  		  });

  		  //calendar.setOption('locale', 'es');

  		  calendar.render();


  	}
  	
  </script>

{% endblock %}